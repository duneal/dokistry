name: ðŸš€ Build & Deploy to Production

on:
  push:
    branches:
      - prod
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERFILE_PATH: docker/Dockerfile.prod

jobs:
  release:
    name: ðŸ·ï¸ Semantic Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    outputs:
      version: ${{ steps.semantic-release.outputs.new_release_version }}
      released: ${{ steps.semantic-release.outputs.new_release_published }}

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Enable Corepack
        run: corepack enable

      - name: ðŸ“¦ Set Yarn version
        run: yarn set version 4.6.0

      - name: ðŸ“¦ Install dependencies
        run: yarn install --immutable

      - name: ðŸ·ï¸ Run semantic-release
        id: semantic-release
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-push:
    name: ðŸ‹ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.outputs.released == 'true'
    outputs:
      full-image-name: ${{ steps.get-image-name.outputs.FULL_IMAGE_NAME }}
      version: ${{ needs.release.outputs.version }}

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Get app name from package.json
        id: get-image-name
        run: |
          APP_NAME=$(jq -r .name package.json)
          echo "FULL_IMAGE_NAME=${{ env.DOCKERHUB_USERNAME }}/$APP_NAME" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Log image name and version
        run: |
          echo "ðŸ“¦ Full image name: ${{ steps.get-image-name.outputs.FULL_IMAGE_NAME }}"
          echo "ðŸ·ï¸  Version: ${{ needs.release.outputs.version }}"

      - name: ðŸ” Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ”¨ Build Docker image
        run: |
          # Build image
          docker build \
            --compress \
            --file ${{ env.DOCKERFILE_PATH }} \
            --tag ${{ steps.get-image-name.outputs.FULL_IMAGE_NAME }}:latest \
            --tag ${{ steps.get-image-name.outputs.FULL_IMAGE_NAME }}:${{ needs.release.outputs.version }} \
            ./

          # Push image
          docker push ${{ steps.get-image-name.outputs.FULL_IMAGE_NAME }}:latest
          docker push ${{ steps.get-image-name.outputs.FULL_IMAGE_NAME }}:${{ needs.release.outputs.version }}

      - name: ðŸ”„ï¸ Verify image push
        run: |
          echo "âœ… Image successfully pushed to Docker Hub"
          echo "ðŸ“¦ Image: ${{ steps.get-image-name.outputs.FULL_IMAGE_NAME }}:latest"
          echo "ðŸ·ï¸  Version tag: ${{ steps.get-image-name.outputs.FULL_IMAGE_NAME }}:${{ needs.release.outputs.version }}"

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f .env.build
          echo "ðŸ§¹ Build environment file cleaned up"

  notify:
    name: ðŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [release, build-and-push]
    if: always()

    steps:
      - name: ðŸŽ‰ Deployment Success
        if: needs.release.outputs.released == 'true' && needs.build-and-push.result == 'success'
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "ðŸ“¦ Image: ${{ needs.build-and-push.outputs.full-image-name }}:latest"
          echo "ðŸ·ï¸  Version: ${{ needs.build-and-push.outputs.version }}"
          echo "ðŸ”— Registry: Docker Hub"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"

      - name: â­ï¸ No release needed
        if: needs.release.outputs.released == 'false'
        run: |
          echo "â„¹ï¸  No release needed - no changes detected or commits don't trigger a release"

      - name: âŒ Deployment Failed
        if: needs.release.outputs.released == 'true' && needs.build-and-push.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"
          exit 1

      - name: ðŸ“§ Prepare email body
        id: prepare-email
        if: always()
        run: |
          if [ "${{ needs.release.outputs.released }}" == "true" ] && [ "${{ needs.build-and-push.result }}" == "success" ]; then
            IMAGES="ðŸ“¦ Images dÃ©ployÃ©es

              - ${{ needs.build-and-push.outputs.full-image-name }}:latest
              - ${{ needs.build-and-push.outputs.full-image-name }}:${{ needs.build-and-push.outputs.version }}"
            SUBJECT="ðŸŽ‰ DÃ©ploiement rÃ©ussi"
          elif [ "${{ needs.release.outputs.released }}" == "true" ] && [ "${{ needs.build-and-push.result }}" == "failure" ]; then
            IMAGES="âŒ Aucune image dÃ©ployÃ©e - Ã©chec du build"
            SUBJECT="âŒ DÃ©ploiement Ã©chouÃ©"
          else
            IMAGES="â„¹ï¸ Aucune image dÃ©ployÃ©e - aucune release nÃ©cessaire"
            SUBJECT="â„¹ï¸ Aucun dÃ©ploiement nÃ©cessaire"
          fi
          
          BODY="ðŸ“‹ Informations du dÃ©ploiement

              ðŸ“¦ DÃ©pÃ´t : ${{ github.repository }}
              ðŸš© Branche : ${{ github.ref_name }}
              ðŸ”‘ Commit : ${{ github.sha }}
              ðŸ‘¤ Auteur : ${{ github.actor }}

            $IMAGES

            ðŸ”— Liens utiles

              - Les dÃ©tails d'exÃ©cution : (${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              - Le commit : (${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})"
          
          echo "subject=$SUBJECT" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ“§ Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ssl0.ovh.net
          server_port: 587
          secure: false
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: CI/CD Pipeline | ${{ steps.prepare-email.outputs.subject }}
          to: ${{ secrets.SMTP_USER }}
          from: QM Web <${{ secrets.SMTP_USER }}>
          body: ${{ steps.prepare-email.outputs.body }}
